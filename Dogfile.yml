- task: clean
  description: Clean compiled binaries
  code: rm -rf dist dog-*

- task: build
  description: Build dog binary for current platform
  env:
    - OUTPUT_PATH=dist/current
    - REV=v0.4.0
  code: |
    go build \
      -ldflags "-X main.Release=$REV -w" \
      -o "${OUTPUT_PATH}/dog" \
      cmd/dog/*.go

- task: install-build-deps
  description: Installs required dependencies for building dog
  code: go get -u github.com/mitchellh/gox

- task: build-all
  description: Build dog binary for all platforms
  env:
    - XC_ARCH=386 amd64
    - XC_OS=linux darwin freebsd openbsd solaris
    - REV=v0.4.0
  pre: 
    - install-build-deps
    - clean
  code: |
    gox \
      -os="${XC_OS}" \
      -arch="${XC_ARCH}" \
      -ldflags "-X main.Release=$REV -w" \
      -output "dist/{{.OS}}_{{.Arch}}/dog" \
      ./cmd/dog/

- task: dist
  description: Put all dist binaries in a compressed file
  env: REV=v0.4.0
  pre: build-all
  code: |
    mv -v dist dog-${REV}
    tar zcvf dog-${REV}.tar.gz dog-${REV}

- task: run-test-dogfiles
  description: Run all Tasks in testdata Dogfiles
  code: ./scripts/test-dogfiles.sh
